name: Sync Javascript Content from Obsidian

on:
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±° ê°€ëŠ¥
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

jobs:
  sync-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout blog repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: softourr/obsidian  # ì†ŒìŠ¤ ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ
          path: source-repo
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Set timezone to KST
        run: |
          sudo timedatectl set-timezone Asia/Seoul
          echo "Current time (KST): $(date)"

      - name: Create target directory if not exists
        run: |
          mkdir -p src/content/posts  # ëŒ€ìƒ í´ë”

      - name: Copy and process markdown files
        run: |
          # Study/Javascript í´ë”ì˜ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì°¾ê¸°
          MARKDOWN_FILES=$(find source-repo/Study/Javascript -name "*.md" || echo "")
          
          if [ -z "$MARKDOWN_FILES" ]; then
            echo "ğŸ”´ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì†ŒìŠ¤ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”."
            
            # ì „ì²´ ì €ì¥ì†Œì—ì„œ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê²€ìƒ‰ (ë””ë²„ê¹…ìš©)
            echo "ì „ì²´ ì €ì¥ì†Œì—ì„œ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ê²€ìƒ‰:"
            find source-repo -name "*.md" | head -n 10
            exit 1
          fi
          
          echo "ğŸŸ¢ ì²˜ë¦¬í•  ë§ˆí¬ë‹¤ìš´ íŒŒì¼: $(echo "$MARKDOWN_FILES" | wc -l)ê°œ"
          
          # ì˜¤ëŠ˜ ë‚ ì§œ (ê¸°ë³¸ ë‚ ì§œ)
          TODAY=$(date +"%Y-%m-%d")
          
          # ê° íŒŒì¼ ì²˜ë¦¬
          for src_file in $MARKDOWN_FILES; do
            filename=$(basename "$src_file")
            dest_file="src/content/posts/$filename"
            
            echo "ğŸ”„ ì²˜ë¦¬ ì¤‘: $src_file -> $dest_file"
            
            # íŒŒì¼ ì œëª© ì¶”ì¶œ (íŒŒì¼ëª…ì—ì„œ)
            title=$(echo "$filename" | sed 's/\.md$//' | sed 's/_/ /g' | sed 's/-/ /g')
            
            # ìˆ˜ì • ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (KST ê¸°ì¤€)
            modified_date=$(git -C source-repo log -1 --format=%ad --date=format:"%Y-%m-%d" -- "$src_file" || echo "$TODAY")
            
            # ë‚ ì§œê°€ ë¹„ì–´ìˆê±°ë‚˜ nullì¸ ê²½ìš° ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
            if [ -z "$modified_date" ] || [ "$modified_date" = "null" ]; then
              modified_date="$TODAY"
              echo "- ìœ íš¨í•œ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: $modified_date"
            fi
            
            # README.md íŒŒì¼ íŠ¹ë³„ ì²˜ë¦¬
            if [ "$filename" = "README.md" ]; then
              echo "- README.md íŒŒì¼ì€ ì¼ë°˜ ì½˜í…ì¸ ì™€ ë‹¤ë¥´ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤"
              title="Javascript Study Guide"
            fi
            
            # í”„ë¡ íŠ¸ë§¤í„° í™•ì¸ ë° ì²˜ë¦¬
            if grep -q "^---" "$src_file"; then
              echo "- ê¸°ì¡´ í”„ë¡ íŠ¸ë§¤í„° ì œê±° ë° ìƒˆ í”„ë¡ íŠ¸ë§¤í„° ì¶”ê°€"
              # ê¸°ì¡´ í”„ë¡ íŠ¸ë§¤í„° ì œê±° í›„ ìƒˆ í”„ë¡ íŠ¸ë§¤í„° ì¶”ê°€
              content=$(sed -e '1{/^---$/!q;};1,/^---$/d' "$src_file")
              
              {
                echo "---"
                echo "title: \"$title\""
                echo "published: $modified_date"
                echo "tags: [Javascript, Study]"
                echo "category: Javascript"
                echo "draft: false"
                echo "---"
                echo "$content"
              } > "$dest_file"
            else
              echo "- ìƒˆ í”„ë¡ íŠ¸ë§¤í„° ì¶”ê°€"
              # í”„ë¡ íŠ¸ë§¤í„°ê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
              {
                echo "---"
                echo "title: \"$title\""
                echo "published: $modified_date"
                echo "tags: [Javascript, Study]"
                echo "category: Javascript"
                echo "draft: false"
                echo "---"
                cat "$src_file"
              } > "$dest_file"
            fi
            
            # í”„ë¡ íŠ¸ë§¤í„°ì— ìœ íš¨í•œ ë‚ ì§œê°€ ìˆëŠ”ì§€ í™•ì¸
            if ! grep -q "published: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}" "$dest_file"; then
              echo "âš ï¸ ìƒì„±ëœ íŒŒì¼ì— ìœ íš¨í•œ published ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ì • ì¤‘..."
              sed -i "s/published: .*/published: $TODAY/" "$dest_file"
            fi
            
            echo "âœ… íŒŒì¼ ìƒì„± ì™„ë£Œ: $dest_file"
          done

      - name: Verify frontmatter
        run: |
          echo "ìƒì„±ëœ íŒŒì¼ì˜ í”„ë¡ íŠ¸ë§¤í„° ê²€ì¦ ì¤‘..."
          for file in src/content/posts/*.md; do
            echo "í™•ì¸ ì¤‘: $file"
            if ! grep -q "published: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}" "$file"; then
              echo "âš ï¸ íŒŒì¼ $fileì— ìœ íš¨í•œ published ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ì • ì¤‘..."
              sed -i "s/published: .*/published: $(date +"%Y-%m-%d")/" "$file"
            fi
          done

      - name: List processed files
        run: |
          echo "ìƒì„±ëœ íŒŒì¼ ëª©ë¡:"
          ls -la src/content/posts/
          echo "ì´ íŒŒì¼ ìˆ˜: $(find src/content/posts -type f | wc -l)"
          
          echo "íŒŒì¼ í”„ë¡ íŠ¸ë§¤í„° ìƒ˜í”Œ:"
          for file in $(ls -1 src/content/posts/ | head -n 3); do
            echo "----- $file -----"
            head -n 10 "src/content/posts/$file"
            echo "-----------------"
          done

      - name: Commit changes if any
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add src/content/posts/
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          git status
          
          if git diff --staged --quiet; then
            echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            git commit -m "Obsidian Javascript í•™ìŠµ ë…¸íŠ¸ ë™ê¸°í™” (KST: $(date +"%Y-%m-%d %H:%M:%S"))"
            git push
            echo "âœ… ë³€ê²½ì‚¬í•­ì„ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹í•˜ê³  í‘¸ì‹œí–ˆìŠµë‹ˆë‹¤"
          fi
